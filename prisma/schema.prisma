// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  walletAddress     String   @unique
  email             String?
  githubId          String?  @unique
  githubUsername    String?  @unique
  githubAccessToken String? // Encrypted GitHub OAuth token
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  profile     Profile?
  githubStats GitHubStats?
  syncLogs    SyncLog[]

  @@index([walletAddress])
  @@index([githubUsername])
}

model Profile {
  id                 String  @id @default(cuid())
  userId             String  @unique
  slug               String  @unique
  displayName        String?
  bio                String?
  avatarUrl          String?
  location           String?
  company            String?
  website            String?
  isPublic           Boolean @default(true)
  talentScore        Float?
  talentPassportData Json?
  viewCount          Int     @default(0)

  // Search optimization fields
  searchTags        String[]  @default([])
  experienceLevel   String? // 'junior' | 'mid' | 'senior' | 'lead'
  yearsOfExperience Int?
  isFeatured        Boolean   @default(false)
  featuredAt        DateTime?
  lastActiveAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  skills ProfileSkill[]

  @@index([slug])
  @@index([isPublic])
  @@index([location])
  @@index([experienceLevel])
  @@index([isFeatured])
  @@index([lastActiveAt])
}

model GitHubStats {
  id     String @id @default(cuid())
  userId String @unique

  // User Stats
  publicRepos Int @default(0)
  publicGists Int @default(0)
  followers   Int @default(0)
  following   Int @default(0)
  totalStars  Int @default(0)
  totalForks  Int @default(0)

  // Activity Stats
  totalCommits       Int @default(0)
  totalPRs           Int @default(0)
  totalIssues        Int @default(0)
  totalContributions Int @default(0)

  // Language Stats (JSON array of {language, percentage, bytes})
  languages Json?

  // Contribution Graph (JSON array of {date, count})
  contributionGraph Json?

  // Top Repositories (JSON array of top repos with details)
  topRepositories Json?

  // Recent Activity (JSON array of recent commits, PRs, issues)
  recentActivity Json?

  // Organizations
  organizations Json?

  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SyncLog {
  id       String   @id @default(cuid())
  userId   String
  syncType String // 'github' | 'talent-protocol'
  status   String // 'success' | 'error' | 'in-progress'
  message  String?
  syncedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([syncType])
}

model Skill {
  id        String   @id @default(cuid())
  name      String   @unique
  category  String // 'language' | 'framework' | 'tool' | 'platform'
  iconUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profileSkills ProfileSkill[]

  @@index([category])
  @@index([name])
}

model ProfileSkill {
  id          String    @id @default(cuid())
  profileId   String
  skillId     String
  proficiency Int // 1-5 scale or percentage
  yearsUsed   Float?
  lastUsed    DateTime?
  verified    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@index([profileId])
  @@index([skillId])
  @@index([proficiency])
}

model SearchQuery {
  id        String   @id @default(cuid())
  query     String
  filters   Json?
  results   Int      @default(0)
  userId    String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}
